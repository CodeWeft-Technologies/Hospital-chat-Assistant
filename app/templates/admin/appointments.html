<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f6f5; }
        .sidebar { width: 200px; background: #93c5fd; position: fixed; height: 100%; padding-top: 20px; }
        .sidebar a { display: block; padding: 10px; text-decoration: none; color: #ecf0f1; }
        .sidebar a:hover { background: #4e66c4; }
        .main-content { margin-left: 220px; padding: 20px; }
        h2 { color: #2c3e50; }
        .filter-section { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; }
        .filter-section label { font-weight: bold; color: #34495e; }
        .filter-section select, .filter-section input { padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 14px; }
        .filter-section input[type="text"] { width: 200px; }
        .filter-section input[type="date"] { width: 150px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ecf0f1; padding: 12px; text-align: left; font-size: 14px; }
        th { background: #6aaff5; color: #ecf0f1; }
        tr:hover { background: #f9f9f9; }
        .status-pending { background: #f1c40f; color: #fff; }
        .status-confirmed { background: #2ecc71; color: #fff; }
        .status-cancelled { background: #e74c3c; color: #fff; }
        .status-booked { background: #3498db; color: #fff; }
        .status-preview { background: #95a5a6; color: #fff; }
        .action-select { padding: 5px; border-radius: 4px; font-size: 14px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: #fff; margin: 10% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .modal-content h3 { color: #2c3e50; }
        .modal-content input, .modal-content select { width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; }
        .modal-content button { padding: 10px 20px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; }
        .modal-content button[type="submit"] { background: #2ecc71; color: #fff; }
        .modal-content button[type="button"] { background: #e74c3c; color: #fff; }
        .add-button { background: #3498db; color: #fff; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .add-button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="/admin/dashboard">Dashboard</a>
        <a href="/admin/departments">Departments</a>
        <a href="/admin/doctors">Doctors</a>
        <a href="/admin/appointments">Appointments</a>
        <a href="/admin/profile">Profile</a>
        <a href="/admin/change-password">Change Password</a>
        <a href="/admin/logout">Logout</a>
    </div>

    <div class="main-content">
        <h2>Appointments</h2>

        <div class="filter-section">
            <div>
                <label>Filter by Status:</label>
                <select id="statusFilter">
                    <option value="">All</option>
                    <option value="upcoming">Upcoming (Next 24 Hrs)</option>
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="booked">Booked</option>
                    <option value="preview">Preview</option>
                </select>
            </div>

            <div>
                <label>Search Appointments:</label>
                <input type="text" id="searchQuery" placeholder="Search by patient, doctor, or department">
            </div>

            <div>
                <label>Filter by Date:</label>
                <input type="date" id="dateFilter">
            </div>
        </div>

        <table id="appointmentsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Patient Name</th>
                    <th>Doctor</th>
                    <th>Department</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="8">Loading appointments...</td></tr>
            </tbody>
        </table>


        <div id="addModal" class="modal">
            <div class="modal-content">
                <h3>Add New Appointment</h3>
                <form id="addAppointmentForm">
                    <label>Patient Name:</label>
                    <input type="text" id="addPatientName" required>

                    <label>Phone Number:</label>
                    <input type="text" id="addPhoneNumber" pattern="[0-9]{10}" required>

                    <label>Department:</label>
                    <select id="addDepartment" required>
                        <option value="">Select Department</option>
                    </select>

                    <label>Doctor:</label>
                    <select id="addDoctor" required>
                        <option value="">Select Doctor</option>
                    </select>

                    <label>Date:</label>
                    <input type="date" id="addDate" required>

                    <label>Time:</label>
                    <input type="time" id="addTime" required>

                    <label>Status:</label>
                    <select id="addStatus" required>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="booked">Booked</option>
                        <option value="preview">Preview</option>
                    </select>

                    <button type="button" onclick="closeAddModal()">Cancel</button>
                    <button type="submit">Save Appointment</button>
                </form>
            </div>
        </div>

        <div id="detailsModal" class="modal">
            <div class="modal-content">
                <h3>Appointment Details</h3>
                <p><strong>ID:</strong> <span id="detailId"></span></p>
                <p><strong>Patient Name:</strong> <span id="detailPatientName"></span></p>
                <p><strong>Phone Number:</strong> <span id="detailPhoneNumber"></span></p>
                <p><strong>Department:</strong> <span id="detailDepartment"></span></p>
                <p><strong>Doctor:</strong> <span id="detailDoctor"></span></p>
                <p><strong>Date:</strong> <span id="detailDate"></span></p>
                <p><strong>Time:</strong> <span id="detailTime"></span></p>
                <p><strong>Status:</strong> <span id="detailStatus"></span></p>
                <button type="button" onclick="closeDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        async function fetchAppointments() {
            try {
                const response = await fetch('/admin/api/appointments', {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const appointments = await response.json();
                renderAppointments(appointments);
            } catch (error) {
                console.error('Error fetching appointments:', error);
                document.querySelector('#appointmentsTable tbody').innerHTML =
                    '<tr><td colspan="8">Error loading appointments.</td></tr>';
            }
        }

        function renderAppointments(appointments) {
            const statusFilter = document.querySelector('#statusFilter').value;
            const searchQuery = (document.querySelector('#searchQuery').value || '').toLowerCase();
            const dateFilter = document.querySelector('#dateFilter').value;

            const filteredAppointments = appointments.filter(appt => {
                const status = (appt.Status || '').toLowerCase();
                const patientName = (appt.patientName || '').toLowerCase();
                const doctorName = (appt.doctorName || '').toLowerCase();
                const department = (appt.department || '').toLowerCase();
                const date = appt.date || '';

                let statusMatch = true;
                if (statusFilter && statusFilter !== 'upcoming') {
                    statusMatch = status === statusFilter.toLowerCase();
                } else if (statusFilter === 'upcoming') {
                    const apptDateTime = new Date(`${date} ${appt.time}`);
                    const now = new Date();
                    const next24Hours = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                    statusMatch = apptDateTime >= now && apptDateTime <= next24Hours;
                }

                const searchMatch = patientName.includes(searchQuery) ||
                                   doctorName.includes(searchQuery) ||
                                   department.includes(searchQuery);

                const dateMatch = !dateFilter || date === dateFilter;

                return statusMatch && searchMatch && dateMatch;
            });

            const tbody = document.querySelector('#appointmentsTable tbody');
            tbody.innerHTML = '';

            if (filteredAppointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No appointments found matching your criteria.</td></tr>';
                return;
            }

            filteredAppointments.forEach(appt => {
                const row = document.createElement('tr');
                row.className = 'appointment-row';
                row.dataset.id = appt.id;
                row.innerHTML = `
                    <td>${appt.id}</td>
                    <td>${appt.patientName || 'N/A'}</td>
                    <td>${appt.doctorName || 'N/A'}</td>
                    <td>${appt.department || 'N/A'}</td>
                    <td>${appt.date || 'N/A'}</td>
                    <td>${appt.time || 'N/A'}</td>
                    <td class="status-${appt.Status.toLowerCase()}">${appt.Status || 'N/A'}</td>
                    <td>
                        <select class="action-select" onchange="updateStatus(${appt.id}, this.value)">
                            <option value="">Select Action</option>
                            <option value="pending" ${appt.Status.toLowerCase() === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="confirmed" ${appt.Status.toLowerCase() === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                            <option value="cancelled" ${appt.Status.toLowerCase() === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            <option value="booked" ${appt.Status.toLowerCase() === 'booked' ? 'selected' : ''}>Booked</option>
                            <option value="preview" ${appt.Status.toLowerCase() === 'preview' ? 'selected' : ''}>Preview</option>
                        </select>
                    </td>
                `;
                row.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'SELECT') showDetails(appt);
                });
                tbody.appendChild(row);
            });
        }

        async function updateStatus(appointmentId, newStatus) {
            if (!newStatus) return; // Ignore "Select Action"
            try {
                const response = await fetch('/admin/api/update_appointment_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ appointmentId: appointmentId, newStatus: newStatus }) 
                });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || `HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                fetchAppointments();
                alert('Status updated successfully!');
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status: ' + error.message);
                fetchAppointments();
            }
        }

        async function fetchDepartmentsAndDoctors() {
            try {
                const deptResponse = await fetch('/admin/api/departments', { credentials: 'include' });
                const departments = await deptResponse.json();
                const deptSelect = document.querySelector('#addDepartment');
                deptSelect.innerHTML = '<option value="">Select Department</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    deptSelect.appendChild(option);
                });

                const docResponse = await fetch('/admin/api/doctors', { credentials: 'include' });
                const doctors = await docResponse.json();
                const docSelect = document.querySelector('#addDoctor');
                docSelect.innerHTML = '<option value="">Select Doctor</option>';
                doctors.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = doc.name.en;
                    option.dataset.departmentId = doc.department_id;
                    docSelect.appendChild(option);
                });

                deptSelect.addEventListener('change', () => {
                    const selectedDept = deptSelect.value;
                    Array.from(docSelect.options).forEach(opt => {
                        if (opt.value === '') return;
                        opt.style.display = opt.dataset.departmentId === selectedDept ? '' : 'none';
                    });
                });
            } catch (error) {
                console.error('Error fetching departments/doctors:', error);
            }
        }

        async function fetchAvailableDays(doctorName) {
            try {
                const response = await fetch('/admin/api/available_days_for_doctor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ doctorName })
                });
                const days = await response.json();
                // Optionally restrict date picker
            } catch (error) {
                console.error('Error fetching available days:', error);
            }
        }

        async function fetchTimeSlots(doctorName) {
            try {
                const response = await fetch('/admin/api/time_slots_for_doctor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ doctorName })
                });
                const { start_time, end_time } = await response.json();
                const timeInput = document.querySelector('#addTime');
                timeInput.min = start_time;
                timeInput.max = end_time;
            } catch (error) {
                console.error('Error fetching time slots:', error);
            }
        }

        function openAddModal() {
            document.querySelector('#addModal').style.display = 'block';
            document.querySelector('#addAppointmentForm').reset();
        }

        function closeAddModal() {
            document.querySelector('#addModal').style.display = 'none';
        }

        function showDetails(appt) {
            document.querySelector('#detailId').textContent = appt.id || 'N/A';
            document.querySelector('#detailPatientName').textContent = appt.patientName || 'N/A';
            document.querySelector('#detailPhoneNumber').textContent = appt.phoneNumber || 'N/A';
            document.querySelector('#detailDepartment').textContent = appt.department || 'N/A';
            document.querySelector('#detailDoctor').textContent = appt.doctorName || 'N/A';
            document.querySelector('#detailDate').textContent = appt.date || 'N/A';
            document.querySelector('#detailTime').textContent = appt.time || 'N/A';
            document.querySelector('#detailStatus').textContent = appt.Status || 'N/A';
            document.querySelector('#detailsModal').style.display = 'block';
        }

        function closeDetailsModal() {
            document.querySelector('#detailsModal').style.display = 'none';
        }

        async function saveAppointment(event) {
            event.preventDefault();
            const data = {
                name: document.querySelector('#addPatientName').value,
                phone: document.querySelector('#addPhoneNumber').value,
                department_id: document.querySelector('#addDepartment').value,
                doctor_id: document.querySelector('#addDoctor').value,
                date: document.querySelector('#addDate').value,
                time: document.querySelector('#addTime').value,
                status: document.querySelector('#addStatus').value
            };

            try {
                const response = await fetch('/admin/save_appointment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                closeAddModal();
                fetchAppointments();
                alert('Appointment saved successfully!');
            } catch (error) {
                console.error('Error saving appointment:', error);
                alert('Failed to save appointment.');
            }
        }

        // Event listeners
        document.querySelector('#statusFilter').addEventListener('change', fetchAppointments);
        document.querySelector('#searchQuery').addEventListener('input', fetchAppointments);
        document.querySelector('#dateFilter').addEventListener('change', fetchAppointments);
        document.querySelector('#addAppointmentForm').addEventListener('submit', saveAppointment);
        document.querySelector('#addDoctor').addEventListener('change', () => {
            const doctorName = document.querySelector('#addDoctor').selectedOptions[0].textContent;
            fetchAvailableDays(doctorName);
            fetchTimeSlots(doctorName);
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchAppointments();
            fetchDepartmentsAndDoctors();
        });
    </script>
</body>
</html>